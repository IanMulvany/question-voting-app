<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Idea Voting App</title>
    <link rel="stylesheet" href="static/css/styles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="static/js/scripts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }

      textarea {
        margin-bottom: 20px;
      }

      #ideas-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }

      .idea-card {
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        padding: 16px;
        margin: 16px;
        width: 300px;
        background-color: white;
      }

      .vote-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }

      .vote-buttons button {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Question Submisison App</h1>
    <textarea
      id="ideas-input"
      rows="10"
      cols="50"
      placeholder="Ask you question..."
    ></textarea>
    <button id="submit-ideas">Submit Questions</button>
    <button id="clear-board">Clear Board</button>
    <div id="ideas-container"></div>
  </body>

  <script>
    $(document).ready(function () {
      const socket = io();

      socket.on("init", function (ideas) {
        for (let idea of ideas) {
          addIdeaCard(idea);
        }
      });

      socket.on("idea", function (idea) {
        addIdeaCard(idea);
      });

      socket.on("update_vote", function (idea) {
        $(`#idea-${idea.id} .vote-count`).text(idea.votes);
      });

      socket.on("clear_board", function () {
        $("#ideas-container").empty();
      });

      $("#submit-ideas").click(function () {
        const inputText = $("#ideas-input").val();

        function parseInput(input) {
          let lines = input.trim().split("\n");
          let ideas = [];
          let currentIdea = null;

          for (let line of lines) {
            if (line.startsWith(" ") || line.startsWith("\t")) {
              if (currentIdea) {
                currentIdea.description += "\n" + line.trim();
              }
            } else {
              if (currentIdea) {
                ideas.push(currentIdea);
              }
              currentIdea = { title: line.trim(), description: "" };
            }
          }

          if (currentIdea) {
            ideas.push(currentIdea);
          }

          return ideas;
        }

        const parsedIdeas = parseInput(inputText);

        for (const idea of parsedIdeas) {
          socket.emit("submit_idea", idea);
        }
      });

      $("#clear-board").click(function () {
        socket.emit("clear_board");
      });

      function addIdeaCard(idea) {
        const card = $("<div>")
          .addClass("idea-card")
          .attr("id", `idea-${idea.id}`);
        const title = $("<h3>").text(idea.title);
        <!-- const description = $("<p>").text(idea.description); -->

        const descriptionList = $("<ul>").addClass(
          "card-description list-unstyled"
        );

        if (idea.description) {
          const descriptionLines = idea.description.split("\n");
          for (const line of descriptionLines) {
            if (line.trim() !== "") {
              const listItem = $("<li>").text(line);
              descriptionList.append(listItem);
            }
          }
        }

        const voteButtons = $("<div>").addClass("vote-buttons");
        const upvoteButton = $("<button>")
          .text("Upvote")
          .addClass("upvote-button");
        const downvoteButton = $("<button>")
          .text("Downvote")
          .addClass("downvote-button");
        const voteCount = $("<span>").text(idea.votes).addClass("vote-count");

        upvoteButton.click(function () {
          socket.emit("vote", { id: idea.id, change: 1 });
        });

        downvoteButton.click(function () {
          socket.emit("vote", { id: idea.id, change: -1 });
        });

        voteButtons.append(upvoteButton, voteCount, downvoteButton);
        card.append(title, descriptionList, voteButtons);
        $("#ideas-container").append(card);
      }
    });
  </script>
</html>
